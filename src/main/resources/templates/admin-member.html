<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>会員管理</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        /* ===== プラン表示バッジ ===== */
        .plan-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .plan-free   { background: #dee2e6; color: #495057; }
        .plan-bronze { background: rgb(205, 127, 50); color: #fff; }
        .plan-silver { background: rgb(205, 205, 205); color: #212529; }
        .plan-gold   { background: rgb(230, 182, 15); color: #212529; }

        /* ===== ★ ここ追加：操作列の横幅調整 ===== */
        .action-cell {
            min-width: 280px; /* 横が潰れない最低幅 */
            white-space: nowrap;
        }

        /* 権限セレクト */
        .action-cell .authority-select {
            width: 90px;
        }

        /* プランセレクト */
        .action-cell .plan-select {
            width: 110px;
        }
    </style>
</head>

<body class="p-4">

<!-- ヘッダー -->
<div th:replace="header2 :: header2"></div>

<h1 class="mb-4 mt-3">会員管理</h1>

<!-- 検索 -->
<form method="get" action="/admin/member" class="mb-4 w-50">
    <div class="input-group">
        <input type="text" class="form-control" name="keyword"
               th:value="${keyword}" placeholder="会員ID or 氏名で検索">
        <button class="btn btn-primary">検索</button>
    </div>
</form>

<table class="table table-bordered align-middle">
    <thead class="table-light">
        <tr>
            <th>ID</th>
            <th>氏名</th>
            <th>メール</th>
            <th>プラン</th>
            <th>権限</th>
            <th>操作</th>
        </tr>
    </thead>

    <tbody>
        <tr th:each="m : ${members}">
            <td th:text="${m.userId}"></td>
            <td th:text="${m.userName}"></td>
            <td th:text="${m.email}"></td>

            <!-- プラン表示 -->
            <td>
                <span th:if="${m.planId == 1}" class="plan-badge plan-free">お試し</span>
                <span th:if="${m.planId == 2}" class="plan-badge plan-bronze">Bronze</span>
                <span th:if="${m.planId == 3}" class="plan-badge plan-silver">Silver</span>
                <span th:if="${m.planId == 4}" class="plan-badge plan-gold">Gold</span>
            </td>

            <!-- 権限表示 -->
            <td th:text="${m.authorityId == 2 ? '管理者' : '一般'}"></td>

            <!-- 操作 -->
            <td class="action-cell">
                <div class="d-flex gap-2">

                    <!-- 権限変更 -->
                    <form method="post"
                          action="/admin/member/authority"
                          class="d-flex gap-1">

                        <!-- CSRF -->
                        <input type="hidden"
                               th:name="${_csrf.parameterName}"
                               th:value="${_csrf.token}">

                        <input type="hidden" name="userId" th:value="${m.userId}">
                        <input type="hidden" name="keyword" th:value="${keyword}">

                        <select name="authorityId"
                                class="form-select form-select-sm authority-select">
                            <option value="1" th:selected="${m.authorityId == 1}">一般</option>
                            <option value="2" th:selected="${m.authorityId == 2}">管理者</option>
                        </select>

                        <button class="btn btn-sm btn-outline-primary">権限</button>
                    </form>

                    <!-- プラン変更 -->
                    <form method="post"
                          action="/admin/member/plan"
                          class="d-flex gap-1">

                        <!-- CSRF -->
                        <input type="hidden"
                               th:name="${_csrf.parameterName}"
                               th:value="${_csrf.token}">

                        <input type="hidden" name="userId" th:value="${m.userId}">
                        <input type="hidden" name="keyword" th:value="${keyword}">

                        <select name="planId"
                                class="form-select form-select-sm plan-select">
                            <option value="1" th:selected="${m.planId == 1}">お試し</option>
                            <option value="2" th:selected="${m.planId == 2}">Bronze</option>
                            <option value="3" th:selected="${m.planId == 3}">Silver</option>
                            <option value="4" th:selected="${m.planId == 4}">Gold</option>
                        </select>

                        <button class="btn btn-sm btn-outline-success">プラン</button>
                    </form>

                </div>
            </td>
        </tr>

        <tr th:if="${#lists.isEmpty(members)}">
            <td colspan="6" class="text-center text-muted">
                該当する会員が見つかりませんでした
            </td>
        </tr>
    </tbody>
</table>

</body>
</html>
