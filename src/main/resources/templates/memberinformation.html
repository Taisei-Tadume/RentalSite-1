<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">

<head>
	<meta charset="UTF-8">
	<title>会員情報</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
	<div>
		<div th:replace="~{header :: siteHeader}"></div>


		<main class="container my-5">
			<h2 class="mb-4 text-center">会員情報</h2>

			<!-- 閲覧履歴カード -->
			<div class="card mb-5">
				<div class="card-body">
					<h4 class="card-title mb-3">閲覧履歴</h4>

					<!-- 履歴がある場合 -->
					<ul class="list-group" th:if="${!#lists.isEmpty(viewHistory)}">
						<li class="list-group-item d-flex justify-content-between align-items-center"
							th:each="history : ${viewHistory}" th:id="'view-' + ${history.id}">
							<!-- 商品名 -->
							<span th:text="${history.product.title}">商品名A</span>
							<!-- 閲覧日時 -->
							<span class="text-muted small"
								th:text="${#temporals.format(history.viewedAt, 'yyyy/MM/dd HH:mm')}">2025/11/28
								12:00</span>
							<!-- 削除ボタン -->
							<button class="btn btn-danger btn-sm" th:attr="data-id=${history.id}"
								onclick="deleteHistory(this)">削除</button>
						</li>
					</ul>

					<!-- 履歴がない場合 -->
					<p th:if="${#lists.isEmpty(viewHistory)}">閲覧履歴はありません。</p>
				</div>
			</div>

			<div class="text-center mb-5">
				<a href="@{/top}" class="btn btn-secondary btn-lg px-5">トップ画面へ戻る</a>
			</div>
		</main>

		<div th:replace="~{footer :: siteFooter}"></div>

	</div>

	<script>
		function deleteHistory(button) {
			const id = button.getAttribute("data-id");
			const target = document.getElementById("view-" + id);
			if (!target) return;

			fetch('/user/viewHistory/delete', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRF-TOKEN': /*[[${_csrf.token}]]*/ ''
				},
				body: JSON.stringify({viewId: id})
			})
				.then(response => {
					if (response.ok) {
						target.remove();
						// 履歴が空になったらメッセージを表示
						if (document.querySelectorAll('#viewHistoryList li').length === 0) {
							document.getElementById('viewHistoryList').innerHTML =
								'<p>閲覧履歴はありません。</p>';
						}
					} else {
						alert("削除に失敗しました。もう一度お試しください。");
					}
				})
				.catch(error => {
					console.error('通信エラー:', error);
					alert("通信エラーが発生しました。");
				});
		}
	</script>

</body>

</html>