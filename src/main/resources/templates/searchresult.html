<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">

<head>
	<meta charset="UTF-8">
	<title>商品検索結果</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="/css/custom.css" rel="stylesheet">
</head>

<body>
	<div id="wrapper">

		<!-- ヘッダー -->
		<div th:replace="~{header :: siteHeader}"></div>

		<main class="container my-5">

			<!-- ソート（ジャンル別）フォーム -->
			<div class="custom-sort-form mb-4">
				<h2>検索結果</h2>

				<form th:action="@{/search}" th:object="${searchForm}" method="get">

					<!-- キーワード保持 -->
					<input type="hidden" th:field="*{keyword}" />

					<select class="form-select" th:field="*{genre}">
						<option value="">全てのジャンル</option>
						<option th:each="g : ${genres}" th:value="${g.genreId}" th:text="${g.genreName}">
						</option>
					</select>

					<button type="submit" class="btn btn-primary mt-2">ソート</button>
				</form>
			</div>

			<!-- エラーメッセージ -->
			<div th:if="${#lists.isEmpty(resultList)}" class="alert alert-warning text-center">
				見つかりませんでした。
			</div>

			<!-- 商品一覧 -->
			<div class="row row-cols-1 row-cols-md-3 g-4" th:if="${!#lists.isEmpty(resultList)}">
				<div class="col" th:each="item : ${resultList}">
					<div class="card h-100 shadow-sm">

						<a th:href="@{/detail/{id}(id=${item.goodsId})}">
							<img th:src="${item.imagePath}" class="card-img-top" alt="商品画像">
						</a>

						<div class="card-body">
							<h5 class="card-title" th:text="${item.title}"></h5>

							<a th:href="@{/detail/{id}(id=${item.goodsId})}"
								class="btn btn-outline-primary mt-2">詳細を見る</a>

							<!-- ★ カート追加 OR 追加済み の出し分け -->
							<div class="mt-2">

								<!-- 追加済み：cartItems の中に同じ goodsId がある場合 -->
								<div th:if="${#lists.contains(#ids(cartItems), item.goodsId)}">
									<button class="btn btn-secondary w-100" disabled>追加済み</button>
								</div>

								<!-- 未追加：cartItems に存在しない場合 -->
								<form th:if="${!#lists.contains(#ids(cartItems), item.goodsId)}"
									th:action="@{/cart/add}" method="post">
									<input type="hidden" name="goodsId" th:value="${item.goodsId}">
									<button type="submit" class="btn btn-success w-100">
										カートに追加
									</button>
